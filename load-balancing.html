<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Load Balancing Complete Guide - L4/L7 algorithms, health checks, session persistence, HA patterns, AWS ALB/NLB, Azure, GCP">
  <title>Load Balancing Guide | NetSec Guide</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="navbar-brand">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      NetSec Guide
    </a>
    <ul class="navbar-nav">
      <li><a href="index.html">Home</a></li>
      <li><a href="network-fundamentals.html">Fundamentals</a></li>
      <li><a href="forward-proxy.html" class="active">Proxies</a></li>
      <li><a href="firewall-concepts.html">Firewalls</a></li>
      <li><a href="troubleshooting.html">Troubleshooting</a></li>
    </ul>
    <button class="menu-toggle" aria-label="Toggle menu">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </nav>

  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">On This Page</div>
      <ul class="sidebar-nav">
        <li><a href="#concepts">Load Balancing Concepts</a></li>
        <li><a href="#l4-vs-l7">Layer 4 vs Layer 7</a></li>
        <li><a href="#algorithms">Algorithms</a></li>
        <li><a href="#health-checks">Health Checks</a></li>
        <li><a href="#session-persistence">Session Persistence</a></li>
        <li><a href="#ha-patterns">HA Patterns</a></li>
        <li><a href="#aws">AWS Load Balancers</a></li>
        <li><a href="#azure">Azure Load Balancers</a></li>
        <li><a href="#gcp">GCP Load Balancers</a></li>
      </ul>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Related Pages</div>
      <ul class="sidebar-nav">
        <li><a href="reverse-proxy.html">Reverse Proxy</a></li>
        <li><a href="forward-proxy.html">Forward Proxy</a></li>
        <li><a href="cloud-networking.html">Cloud Networking</a></li>
      </ul>
    </div>
  </aside>

  <main class="main-content">
    <div class="content-wrapper">
      <nav class="breadcrumb">
        <span class="breadcrumb-item"><a href="index.html">Home</a></span>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-item active">Load Balancing</span>
      </nav>

      <h1>Load Balancing - Complete Guide</h1>
      <p class="hero-subtitle">
        Master load balancing concepts, algorithms, and implementations across on-premises 
        and cloud environments for high availability and scalability.
      </p>

      <!-- Concepts -->
      <section>
        <h2 id="concepts">Load Balancing Concepts</h2>
        <p>
          Load balancing distributes incoming network traffic across multiple backend servers 
          to ensure no single server becomes overwhelmed, improving reliability and performance.
        </p>

        <div class="ascii-diagram">
          <div class="ascii-diagram-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            Load Balancer Architecture
          </div>
          <pre>
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          LOAD BALANCER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│                              CLIENTS                                                │
│            ┌──────────┐   ┌──────────┐   ┌──────────┐                              │
│            │ Client 1 │   │ Client 2 │   │ Client 3 │                              │
│            └────┬─────┘   └────┬─────┘   └────┬─────┘                              │
│                 │              │              │                                     │
│                 └──────────────┼──────────────┘                                     │
│                                │                                                    │
│                                ▼                                                    │
│                   ┌────────────────────────┐                                        │
│                   │     LOAD BALANCER      │                                        │
│                   │                        │                                        │
│                   │  ┌──────────────────┐  │                                        │
│                   │  │ • Health Checks  │  │                                        │
│                   │  │ • Algorithm      │  │                                        │
│                   │  │ • Session Stick  │  │                                        │
│                   │  │ • SSL Termination│  │                                        │
│                   │  └──────────────────┘  │                                        │
│                   │                        │                                        │
│                   │    VIP: 10.0.0.100     │                                        │
│                   └───────────┬────────────┘                                        │
│                               │                                                     │
│           ┌───────────────────┼───────────────────┐                                 │
│           │                   │                   │                                 │
│           ▼                   ▼                   ▼                                 │
│   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐                        │
│   │   Server 1    │   │   Server 2    │   │   Server 3    │                        │
│   │  10.0.1.10    │   │  10.0.1.11    │   │  10.0.1.12    │                        │
│   │   ● Active    │   │   ● Active    │   │   ○ Draining  │                        │
│   │   Load: 45%   │   │   Load: 52%   │   │   Load: 78%   │                        │
│   └───────────────┘   └───────────────┘   └───────────────┘                        │
│                                                                                     │
│   KEY BENEFITS:                                                                     │
│   ─────────────                                                                     │
│   • High Availability: If one server fails, others handle traffic                  │
│   • Scalability: Add servers to handle more load                                   │
│   • Performance: Distribute load evenly across servers                             │
│   • Flexibility: Perform maintenance without downtime                              │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
          </pre>
        </div>
      </section>

      <!-- L4 vs L7 -->
      <section>
        <h2 id="l4-vs-l7">Layer 4 vs Layer 7 Load Balancing</h2>

        <div class="ascii-diagram">
          <div class="ascii-diagram-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            L4 vs L7 Comparison
          </div>
          <pre>
LAYER 4 (Transport Layer) LOAD BALANCING
═══════════════════════════════════════════════════════════════════════════════

  Client                    Load Balancer                    Servers
    │                            │                              │
    │  TCP SYN ─────────────────►│                              │
    │                            │ Decision based on:           │
    │                            │ • Source IP                  │
    │                            │ • Destination IP             │
    │                            │ • Source Port                │
    │                            │ • Destination Port           │
    │                            │                              │
    │                            │ TCP SYN ────────────────────►│ Server 1
    │◄────────────────────────── │ ◄────────────────────────────│
    │  (Connection established)  │  (Packets forwarded)         │
    │                            │                              │

  • Fast - operates at network level
  • Protocol agnostic (works with any TCP/UDP)
  • Cannot inspect application content
  • Cannot route based on URL, headers, cookies


LAYER 7 (Application Layer) LOAD BALANCING
═══════════════════════════════════════════════════════════════════════════════

  Client                    Load Balancer                    Servers
    │                            │                              │
    │  TCP SYN ─────────────────►│                              │
    │◄──────────────────────────►│ (TCP handshake with LB)     │
    │                            │                              │
    │  HTTP GET /api/users ─────►│                              │
    │                            │ Decision based on:           │
    │                            │ • URL path (/api/*)          │
    │                            │ • HTTP headers               │
    │                            │ • Cookies                    │
    │                            │ • Request content            │
    │                            │                              │
    │                            │ HTTP GET /api/users ────────►│ API Server
    │                            │ ◄────────────────────────────│
    │◄───────────────────────────│                              │
    │  HTTP 200 OK               │                              │

  • Content-aware routing
  • Can terminate SSL
  • URL-based routing (/api → API servers, /static → CDN)
  • Header manipulation
  • More CPU intensive
          </pre>
        </div>

        <div class="table-wrapper">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Feature</th>
                <th>Layer 4</th>
                <th>Layer 7</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Speed</strong></td>
                <td><span class="feature-yes">Faster</span></td>
                <td>Slower (more processing)</td>
              </tr>
              <tr>
                <td><strong>SSL Termination</strong></td>
                <td><span class="feature-no">No</span> (passthrough)</td>
                <td><span class="feature-yes">Yes</span></td>
              </tr>
              <tr>
                <td><strong>Content Routing</strong></td>
                <td><span class="feature-no">No</span></td>
                <td><span class="feature-yes">Yes</span> (URL, headers)</td>
              </tr>
              <tr>
                <td><strong>Protocol Support</strong></td>
                <td>Any TCP/UDP</td>
                <td>HTTP/HTTPS primarily</td>
              </tr>
              <tr>
                <td><strong>Connection Handling</strong></td>
                <td>Pass-through</td>
                <td>Terminates connections</td>
              </tr>
              <tr>
                <td><strong>Health Checks</strong></td>
                <td>TCP/UDP only</td>
                <td>HTTP status codes</td>
              </tr>
              <tr>
                <td><strong>Use Cases</strong></td>
                <td>Databases, gaming, VoIP</td>
                <td>Web apps, APIs, microservices</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Algorithms -->
      <section>
        <h2 id="algorithms">Load Balancing Algorithms</h2>

        <div class="ascii-diagram">
          <div class="ascii-diagram-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            Load Balancing Algorithms Visualized
          </div>
          <pre>
ROUND ROBIN
═══════════════════════════════════════════════════════════════════════════════
  Request 1 → Server A
  Request 2 → Server B
  Request 3 → Server C
  Request 4 → Server A  (cycle repeats)
  Request 5 → Server B
  ...

  Simple, fair distribution. Doesn't consider server load.


WEIGHTED ROUND ROBIN
═══════════════════════════════════════════════════════════════════════════════
  Server A (weight=3): ●●●
  Server B (weight=2): ●●
  Server C (weight=1): ●

  Request sequence: A, A, A, B, B, C, A, A, A, B, B, C...

  Use when servers have different capacities.


LEAST CONNECTIONS
═══════════════════════════════════════════════════════════════════════════════
  Server A: 5 connections  ─┐
  Server B: 3 connections  ─┼─► New request → Server C (fewest)
  Server C: 2 connections  ─┘

  Best for varying request durations (long-lived connections).


IP HASH
═══════════════════════════════════════════════════════════════════════════════
  Client 192.168.1.10 → hash(IP) % 3 = 0 → Server A
  Client 192.168.1.11 → hash(IP) % 3 = 1 → Server B
  Client 192.168.1.12 → hash(IP) % 3 = 2 → Server C

  Same client always goes to same server (basic session persistence).


LEAST RESPONSE TIME
═══════════════════════════════════════════════════════════════════════════════
  Server A: 50ms avg response
  Server B: 30ms avg response  ← New request goes here
  Server C: 45ms avg response

  Combines connection count with response time.


RESOURCE BASED (Adaptive)
═══════════════════════════════════════════════════════════════════════════════
  Server A: CPU 80%, Memory 60%  → Score: 70
  Server B: CPU 40%, Memory 50%  → Score: 45  ← Lowest, gets request
  Server C: CPU 60%, Memory 70%  → Score: 65

  Requires agent on servers reporting health metrics.
          </pre>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Algorithm</th>
                <th>Best For</th>
                <th>Pros</th>
                <th>Cons</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Round Robin</strong></td>
                <td>Similar servers, short requests</td>
                <td>Simple, predictable</td>
                <td>Ignores server load</td>
              </tr>
              <tr>
                <td><strong>Weighted Round Robin</strong></td>
                <td>Mixed server capacities</td>
                <td>Capacity-aware</td>
                <td>Static weights</td>
              </tr>
              <tr>
                <td><strong>Least Connections</strong></td>
                <td>Long-lived connections</td>
                <td>Dynamic, adaptive</td>
                <td>Doesn't consider response time</td>
              </tr>
              <tr>
                <td><strong>IP Hash</strong></td>
                <td>Session persistence needed</td>
                <td>Consistent routing</td>
                <td>Uneven with few clients</td>
              </tr>
              <tr>
                <td><strong>Least Response Time</strong></td>
                <td>Performance-critical apps</td>
                <td>Optimal distribution</td>
                <td>More overhead</td>
              </tr>
              <tr>
                <td><strong>Random</strong></td>
                <td>Stateless, uniform requests</td>
                <td>Simple, no state</td>
                <td>Not optimal</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Health Checks -->
      <section>
        <h2 id="health-checks">Health Checks</h2>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Config</span>
            <span class="code-filename">Health Check Types</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# HEALTH CHECK TYPES
# =============================================================================

# TCP Health Check (Layer 4)
# Simply checks if port is accepting connections
# Fast, low overhead, but doesn't verify application health
health_check {
    type        = "tcp"
    port        = 8080
    interval    = 10s
    timeout     = 5s
    healthy_threshold   = 2    # 2 successes to mark healthy
    unhealthy_threshold = 3    # 3 failures to mark unhealthy
}

# HTTP Health Check (Layer 7)
# Verifies application responds correctly
health_check {
    type        = "http"
    port        = 8080
    path        = "/health"
    interval    = 30s
    timeout     = 10s
    expected_codes = [200, 201]
    # Can also check response body
    match {
        body = "OK"
    }
}

# HTTPS Health Check
health_check {
    type        = "https"
    port        = 443
    path        = "/api/health"
    interval    = 30s
    timeout     = 10s
}

# gRPC Health Check
health_check {
    type        = "grpc"
    port        = 50051
    grpc_service_name = "my.service.Health"
}

# =============================================================================
# HEALTH CHECK BEST PRACTICES
# =============================================================================

# 1. Dedicated health endpoint
# Don't use "/" - use dedicated endpoint that checks dependencies
GET /health
{
    "status": "healthy",
    "database": "connected",
    "cache": "connected",
    "timestamp": "2024-01-15T10:30:00Z"
}

# 2. Appropriate intervals
# - Too frequent: unnecessary load
# - Too infrequent: slow failover
# Typical: 10-30 seconds

# 3. Reasonable thresholds
# - Avoid single failure marking unhealthy (transient issues)
# - Don't require too many failures (slow detection)
# Typical: 2-3 failures to mark unhealthy

# 4. Separate liveness vs readiness
# Liveness: Is the process running?
# Readiness: Is it ready to serve traffic?</code></pre>
        </div>
      </section>

      <!-- Session Persistence -->
      <section>
        <h2 id="session-persistence">Session Persistence (Sticky Sessions)</h2>

        <div class="ascii-diagram">
          <div class="ascii-diagram-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            Session Persistence Methods
          </div>
          <pre>
SOURCE IP PERSISTENCE
═══════════════════════════════════════════════════════════════════════════════

  Client 192.168.1.10                    Load Balancer
         │                                    │
         │  Request 1 ──────────────────────► │ ──► Server A
         │                                    │     (records: 192.168.1.10 → A)
         │  Request 2 ──────────────────────► │ ──► Server A (same client IP)
         │  Request 3 ──────────────────────► │ ──► Server A
         │                                    │

  ⚠️ Problem: Multiple users behind NAT share same IP


COOKIE-BASED PERSISTENCE
═══════════════════════════════════════════════════════════════════════════════

  Client                                  Load Balancer
    │                                          │
    │  Request 1 (no cookie) ─────────────────►│ ──► Server B
    │                                          │
    │◄──── Response + Set-Cookie: SERVERID=B ──│
    │                                          │
    │  Request 2 (Cookie: SERVERID=B) ────────►│ ──► Server B (follows cookie)
    │                                          │

  Types:
  • LB-generated cookie (SERVERID, JSESSIONID)
  • Application cookie (session ID)


SSL SESSION ID PERSISTENCE
═══════════════════════════════════════════════════════════════════════════════

  Uses SSL/TLS session ID to maintain persistence
  Only works with SSL passthrough (not termination)


CUSTOM HEADER PERSISTENCE
═══════════════════════════════════════════════════════════════════════════════

  Client                                  Load Balancer
    │                                          │
    │  X-User-ID: user123 ────────────────────►│ ──► Server C
    │                                          │     (hash user123 → Server C)
    │  X-User-ID: user123 ────────────────────►│ ──► Server C (same user)
    │                                          │
          </pre>
        </div>

        <div class="alert alert-warning">
          <svg class="alert-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          <div class="alert-content">
            <div class="alert-title">Sticky Sessions Trade-offs</div>
            <p>Sticky sessions can cause uneven load distribution. If possible, design stateless applications that store session data in shared storage (Redis, database) rather than relying on sticky sessions.</p>
          </div>
        </div>
      </section>

      <!-- HA Patterns -->
      <section>
        <h2 id="ha-patterns">High Availability Patterns</h2>

        <div class="ascii-diagram">
          <div class="ascii-diagram-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            Load Balancer HA Configurations
          </div>
          <pre>
ACTIVE-PASSIVE (Failover)
═══════════════════════════════════════════════════════════════════════════════

                    ┌─────────────────────────────────┐
                    │         Virtual IP (VIP)         │
                    │         203.0.113.100            │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │     LB 1      │  ◄──────────► │     LB 2      │
            │   (ACTIVE)    │   Heartbeat   │   (PASSIVE)   │
            │   Owns VIP    │   VRRP/CARP   │   Standby     │
            └───────────────┘               └───────────────┘

  • Only active LB processes traffic
  • Passive takes over if active fails (seconds)
  • State synchronization between nodes
  • Protocols: VRRP, CARP, Keepalived


ACTIVE-ACTIVE (Load Sharing)
═══════════════════════════════════════════════════════════════════════════════

                              DNS/Anycast
                    ┌─────────────────────────────────┐
                    │    app.example.com resolves to  │
                    │    203.0.113.100 AND            │
                    │    203.0.113.101                │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │     LB 1      │  ◄──────────► │     LB 2      │
            │   (ACTIVE)    │  Session Sync │   (ACTIVE)    │
            │ 203.0.113.100 │               │ 203.0.113.101 │
            └───────┬───────┘               └───────┬───────┘
                    │                               │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                            Backend Servers

  • Both LBs process traffic simultaneously
  • Better resource utilization
  • More complex session synchronization
  • DNS round robin or BGP anycast for distribution


GLOBAL LOAD BALANCING (GSLB)
═══════════════════════════════════════════════════════════════════════════════

                              DNS Query
                                  │
                                  ▼
                    ┌─────────────────────────────────┐
                    │        GSLB / DNS LB            │
                    │   (Intelligent DNS response)    │
                    │                                 │
                    │   User in US → US datacenter   │
                    │   User in EU → EU datacenter   │
                    │   Unhealthy DC → Redirect      │
                    └─────────────────────────────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              │                   │                   │
              ▼                   ▼                   ▼
      ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
      │  US-EAST    │     │  US-WEST    │     │  EU-WEST    │
      │   DC + LB   │     │   DC + LB   │     │   DC + LB   │
      └─────────────┘     └─────────────┘     └─────────────┘

  Methods:
  • GeoDNS: Route based on client location
  • Latency-based: Route to fastest datacenter
  • Health-based: Route away from unhealthy DCs
          </pre>
        </div>
      </section>

      <!-- AWS -->
      <section>
        <h2 id="aws">AWS Load Balancers</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Layer</th>
                <th>Protocols</th>
                <th>Use Cases</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>ALB</strong> (Application)</td>
                <td>L7</td>
                <td>HTTP, HTTPS, gRPC</td>
                <td>Web apps, microservices, containers</td>
              </tr>
              <tr>
                <td><strong>NLB</strong> (Network)</td>
                <td>L4</td>
                <td>TCP, UDP, TLS</td>
                <td>High performance, gaming, IoT</td>
              </tr>
              <tr>
                <td><strong>GLB</strong> (Gateway)</td>
                <td>L3</td>
                <td>IP</td>
                <td>Third-party appliances (firewalls)</td>
              </tr>
              <tr>
                <td><strong>CLB</strong> (Classic)</td>
                <td>L4/L7</td>
                <td>HTTP, HTTPS, TCP</td>
                <td>Legacy (not recommended)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">AWS Application Load Balancer</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# AWS APPLICATION LOAD BALANCER (ALB)
# =============================================================================

# ALB
resource "aws_lb" "main" {
  name               = "my-app-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb.id]
  subnets            = [aws_subnet.public_a.id, aws_subnet.public_b.id]

  enable_deletion_protection = true

  tags = {
    Environment = "production"
  }
}

# Target Group
resource "aws_lb_target_group" "app" {
  name     = "my-app-tg"
  port     = 8080
  protocol = "HTTP"
  vpc_id   = aws_vpc.main.id

  health_check {
    enabled             = true
    healthy_threshold   = 2
    unhealthy_threshold = 3
    timeout             = 5
    interval            = 30
    path                = "/health"
    matcher             = "200"
  }

  stickiness {
    type            = "lb_cookie"
    cookie_duration = 86400
    enabled         = true
  }
}

# HTTPS Listener
resource "aws_lb_listener" "https" {
  load_balancer_arn = aws_lb.main.arn
  port              = "443"
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-TLS13-1-2-2021-06"
  certificate_arn   = aws_acm_certificate.main.arn

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.app.arn
  }
}

# HTTP to HTTPS Redirect
resource "aws_lb_listener" "http_redirect" {
  load_balancer_arn = aws_lb.main.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type = "redirect"
    redirect {
      port        = "443"
      protocol    = "HTTPS"
      status_code = "HTTP_301"
    }
  }
}

# Path-based Routing
resource "aws_lb_listener_rule" "api" {
  listener_arn = aws_lb_listener.https.arn
  priority     = 100

  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.api.arn
  }

  condition {
    path_pattern {
      values = ["/api/*"]
    }
  }
}

# Host-based Routing
resource "aws_lb_listener_rule" "admin" {
  listener_arn = aws_lb_listener.https.arn
  priority     = 200

  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.admin.arn
  }

  condition {
    host_header {
      values = ["admin.example.com"]
    }
  }
}</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">AWS Network Load Balancer</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# AWS NETWORK LOAD BALANCER (NLB)
# =============================================================================

resource "aws_lb" "network" {
  name               = "my-app-nlb"
  internal           = false
  load_balancer_type = "network"
  subnets            = [aws_subnet.public_a.id, aws_subnet.public_b.id]

  enable_cross_zone_load_balancing = true
}

# TCP Target Group
resource "aws_lb_target_group" "tcp" {
  name     = "my-tcp-tg"
  port     = 6379
  protocol = "TCP"
  vpc_id   = aws_vpc.main.id

  health_check {
    enabled             = true
    protocol            = "TCP"
    healthy_threshold   = 2
    unhealthy_threshold = 2
    interval            = 10
  }
}

# TCP Listener
resource "aws_lb_listener" "tcp" {
  load_balancer_arn = aws_lb.network.arn
  port              = "6379"
  protocol          = "TCP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tcp.arn
  }
}

# TLS Listener (with certificate)
resource "aws_lb_listener" "tls" {
  load_balancer_arn = aws_lb.network.arn
  port              = "443"
  protocol          = "TLS"
  certificate_arn   = aws_acm_certificate.main.arn
  ssl_policy        = "ELBSecurityPolicy-TLS13-1-2-2021-06"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tcp.arn
  }
}</code></pre>
        </div>
      </section>

      <!-- Azure -->
      <section>
        <h2 id="azure">Azure Load Balancers</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Layer</th>
                <th>Scope</th>
                <th>Use Cases</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Azure Load Balancer</strong></td>
                <td>L4</td>
                <td>Regional</td>
                <td>High-perf TCP/UDP, internal LB</td>
              </tr>
              <tr>
                <td><strong>Application Gateway</strong></td>
                <td>L7</td>
                <td>Regional</td>
                <td>Web apps, WAF, SSL termination</td>
              </tr>
              <tr>
                <td><strong>Front Door</strong></td>
                <td>L7</td>
                <td>Global</td>
                <td>Global HTTP LB, CDN, WAF</td>
              </tr>
              <tr>
                <td><strong>Traffic Manager</strong></td>
                <td>DNS</td>
                <td>Global</td>
                <td>DNS-based traffic routing</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">Azure Application Gateway</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# AZURE APPLICATION GATEWAY
# =============================================================================

resource "azurerm_application_gateway" "main" {
  name                = "myAppGateway"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location

  sku {
    name     = "Standard_v2"
    tier     = "Standard_v2"
    capacity = 2
  }

  gateway_ip_configuration {
    name      = "gateway-ip-config"
    subnet_id = azurerm_subnet.gateway.id
  }

  frontend_port {
    name = "https-port"
    port = 443
  }

  frontend_ip_configuration {
    name                 = "frontend-ip"
    public_ip_address_id = azurerm_public_ip.gateway.id
  }

  backend_address_pool {
    name = "backend-pool"
  }

  backend_http_settings {
    name                  = "http-settings"
    cookie_based_affinity = "Enabled"
    port                  = 80
    protocol              = "Http"
    request_timeout       = 30

    probe_name = "health-probe"
  }

  probe {
    name                = "health-probe"
    protocol            = "Http"
    path                = "/health"
    host                = "127.0.0.1"
    interval            = 30
    timeout             = 30
    unhealthy_threshold = 3
  }

  http_listener {
    name                           = "https-listener"
    frontend_ip_configuration_name = "frontend-ip"
    frontend_port_name             = "https-port"
    protocol                       = "Https"
    ssl_certificate_name           = "ssl-cert"
  }

  ssl_certificate {
    name     = "ssl-cert"
    data     = filebase64("certificate.pfx")
    password = var.ssl_password
  }

  request_routing_rule {
    name                       = "routing-rule"
    rule_type                  = "Basic"
    http_listener_name         = "https-listener"
    backend_address_pool_name  = "backend-pool"
    backend_http_settings_name = "http-settings"
    priority                   = 100
  }
}</code></pre>
        </div>
      </section>

      <!-- GCP -->
      <section>
        <h2 id="gcp">GCP Load Balancers</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Layer</th>
                <th>Scope</th>
                <th>Use Cases</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>HTTP(S) LB</strong></td>
                <td>L7</td>
                <td>Global</td>
                <td>Web apps, global anycast</td>
              </tr>
              <tr>
                <td><strong>TCP Proxy</strong></td>
                <td>L4</td>
                <td>Global</td>
                <td>Non-HTTP TCP with SSL</td>
              </tr>
              <tr>
                <td><strong>SSL Proxy</strong></td>
                <td>L4</td>
                <td>Global</td>
                <td>SSL termination for TCP</td>
              </tr>
              <tr>
                <td><strong>Network LB</strong></td>
                <td>L4</td>
                <td>Regional</td>
                <td>UDP, TCP passthrough</td>
              </tr>
              <tr>
                <td><strong>Internal TCP/UDP</strong></td>
                <td>L4</td>
                <td>Regional</td>
                <td>Internal services</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">GCP HTTP(S) Load Balancer</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# GCP GLOBAL HTTP(S) LOAD BALANCER
# =============================================================================

# Backend Service
resource "google_compute_backend_service" "default" {
  name                  = "my-backend-service"
  protocol              = "HTTP"
  port_name             = "http"
  timeout_sec           = 30
  health_checks         = [google_compute_health_check.default.id]
  load_balancing_scheme = "EXTERNAL"

  backend {
    group           = google_compute_instance_group_manager.default.instance_group
    balancing_mode  = "UTILIZATION"
    capacity_scaler = 1.0
  }

  cdn_policy {
    cache_mode = "CACHE_ALL_STATIC"
  }
}

# Health Check
resource "google_compute_health_check" "default" {
  name               = "my-health-check"
  check_interval_sec = 10
  timeout_sec        = 5

  http_health_check {
    port         = 80
    request_path = "/health"
  }
}

# URL Map
resource "google_compute_url_map" "default" {
  name            = "my-url-map"
  default_service = google_compute_backend_service.default.id

  host_rule {
    hosts        = ["api.example.com"]
    path_matcher = "api"
  }

  path_matcher {
    name            = "api"
    default_service = google_compute_backend_service.api.id

    path_rule {
      paths   = ["/v1/*"]
      service = google_compute_backend_service.api_v1.id
    }
  }
}

# HTTPS Proxy
resource "google_compute_target_https_proxy" "default" {
  name             = "my-https-proxy"
  url_map          = google_compute_url_map.default.id
  ssl_certificates = [google_compute_managed_ssl_certificate.default.id]
}

# Global Forwarding Rule
resource "google_compute_global_forwarding_rule" "default" {
  name       = "my-forwarding-rule"
  target     = google_compute_target_https_proxy.default.id
  port_range = "443"
  ip_address = google_compute_global_address.default.address
}</code></pre>
        </div>
      </section>

      <section>
        <div class="section-divider"><span>Related Guides</span></div>
        <div class="card-grid">
          <a href="reverse-proxy.html" class="nav-card card">
            <h4>Reverse Proxy →</h4>
            <p>Nginx, HAProxy, Traefik configurations.</p>
          </a>
          <a href="cloud-networking.html" class="nav-card card">
            <h4>Cloud Networking →</h4>
            <p>AWS VPC, Azure VNet, GCP networking.</p>
          </a>
          <a href="troubleshooting.html" class="nav-card card">
            <h4>Troubleshooting →</h4>
            <p>Diagnose load balancer issues.</p>
          </a>
        </div>
      </section>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-bottom">
      <p>Network Security & Infrastructure Guide</p>
    </div>
  </footer>

  <script src="main.js"></script>
</body>
</html>
