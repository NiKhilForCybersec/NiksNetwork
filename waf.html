<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Web Application Firewall Guide - ModSecurity, OWASP CRS, AWS WAF, Azure WAF, Cloudflare WAF">
  <title>WAF Guide | NetSec Guide</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="navbar-brand">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      NetSec Guide
    </a>
    <ul class="navbar-nav">
      <li><a href="index.html">Home</a></li>
      <li><a href="network-fundamentals.html">Fundamentals</a></li>
      <li><a href="forward-proxy.html">Proxies</a></li>
      <li><a href="firewall-concepts.html">Firewalls</a></li>
      <li><a href="troubleshooting.html">Troubleshooting</a></li>
    </ul>
    <button class="menu-toggle" aria-label="Toggle menu">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </nav>

  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">On This Page</div>
      <ul class="sidebar-nav">
        <li><a href="#overview">WAF Overview</a></li>
        <li><a href="#owasp">OWASP Top 10</a></li>
        <li><a href="#modsecurity">ModSecurity</a></li>
        <li><a href="#aws-waf">AWS WAF</a></li>
        <li><a href="#azure-waf">Azure WAF</a></li>
        <li><a href="#cloudflare">Cloudflare WAF</a></li>
        <li><a href="#tuning">WAF Tuning</a></li>
      </ul>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Related Pages</div>
      <ul class="sidebar-nav">
        <li><a href="reverse-proxy.html">Reverse Proxy</a></li>
        <li><a href="load-balancing.html">Load Balancing</a></li>
        <li><a href="ids-ips.html">IDS/IPS</a></li>
      </ul>
    </div>
  </aside>

  <main class="main-content">
    <div class="content-wrapper">
      <nav class="breadcrumb">
        <span class="breadcrumb-item"><a href="index.html">Home</a></span>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-item active">Web Application Firewall</span>
      </nav>

      <h1>Web Application Firewall (WAF) Guide</h1>
      <p class="hero-subtitle">
        Comprehensive guide to protecting web applications with WAF technology. 
        Covers ModSecurity, cloud WAF solutions, and OWASP Core Rule Set.
      </p>

      <!-- Overview -->
      <section>
        <h2 id="overview">WAF Overview</h2>

        <div class="ascii-diagram">
          <div class="ascii-diagram-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            WAF Deployment Architecture
          </div>
          <pre>
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      WEB APPLICATION FIREWALL (WAF)                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   WHAT WAF PROTECTS AGAINST:                                                        │
│   ══════════════════════════                                                        │
│                                                                                     │
│   User/Attacker ──► WAF ──► Web Application                                        │
│                      │                                                              │
│                      │ Inspects:                                                    │
│                      │ • HTTP headers                                               │
│                      │ • Query strings                                              │
│                      │ • POST body                                                  │
│                      │ • Cookies                                                    │
│                      │ • File uploads                                               │
│                      │                                                              │
│                      │ Blocks:                                                      │
│                      │ • SQL Injection                                              │
│                      │ • Cross-Site Scripting (XSS)                                │
│                      │ • Remote File Inclusion                                      │
│                      │ • Command Injection                                          │
│                      │ • Path Traversal                                             │
│                      │ • Protocol violations                                        │
│                                                                                     │
│                                                                                     │
│   DEPLOYMENT MODELS:                                                                │
│   ══════════════════                                                                │
│                                                                                     │
│   1. INLINE (Reverse Proxy Mode)                                                   │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐                                    │
│   │  Client  │───►│   WAF    │───►│ Web App  │                                    │
│   └──────────┘    └──────────┘    └──────────┘                                    │
│                   WAF terminates                                                    │
│                   connection                                                        │
│                                                                                     │
│   2. CLOUD/CDN WAF                                                                  │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐                    │
│   │  Client  │───►│   CDN    │───►│   WAF    │───►│ Web App  │                    │
│   └──────────┘    │  (Edge)  │    │ (Cloud)  │    │ (Origin) │                    │
│                   └──────────┘    └──────────┘    └──────────┘                    │
│                                                                                     │
│   3. EMBEDDED (Module)                                                              │
│   ┌──────────┐    ┌────────────────────────────┐                                   │
│   │  Client  │───►│  Web Server + WAF Module   │                                   │
│   └──────────┘    │  (Apache + ModSecurity)    │                                   │
│                   └────────────────────────────┘                                   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
          </pre>
        </div>
      </section>

      <!-- OWASP Top 10 -->
      <section>
        <h2 id="owasp">OWASP Top 10 Web Vulnerabilities</h2>
        <p>
          The OWASP Top 10 represents the most critical web application security risks. 
          A properly configured WAF helps mitigate many of these threats.
        </p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Vulnerability</th>
                <th>Description</th>
                <th>WAF Mitigation</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>A01</strong></td>
                <td>Broken Access Control</td>
                <td>Unauthorized access to resources</td>
                <td>Partial (path traversal rules)</td>
              </tr>
              <tr>
                <td><strong>A02</strong></td>
                <td>Cryptographic Failures</td>
                <td>Weak encryption, data exposure</td>
                <td>Limited (force HTTPS)</td>
              </tr>
              <tr>
                <td><strong>A03</strong></td>
                <td>Injection</td>
                <td>SQL, NoSQL, OS, LDAP injection</td>
                <td><span class="feature-yes">Strong</span></td>
              </tr>
              <tr>
                <td><strong>A04</strong></td>
                <td>Insecure Design</td>
                <td>Missing security controls</td>
                <td>Limited (defense in depth)</td>
              </tr>
              <tr>
                <td><strong>A05</strong></td>
                <td>Security Misconfiguration</td>
                <td>Default configs, verbose errors</td>
                <td>Partial (hide errors)</td>
              </tr>
              <tr>
                <td><strong>A06</strong></td>
                <td>Vulnerable Components</td>
                <td>Outdated libraries with CVEs</td>
                <td>Partial (virtual patching)</td>
              </tr>
              <tr>
                <td><strong>A07</strong></td>
                <td>Authentication Failures</td>
                <td>Brute force, credential stuffing</td>
                <td><span class="feature-yes">Strong (rate limiting)</span></td>
              </tr>
              <tr>
                <td><strong>A08</strong></td>
                <td>Integrity Failures</td>
                <td>Insecure deserialization</td>
                <td>Partial</td>
              </tr>
              <tr>
                <td><strong>A09</strong></td>
                <td>Logging Failures</td>
                <td>Insufficient logging/monitoring</td>
                <td><span class="feature-yes">Strong (logging)</span></td>
              </tr>
              <tr>
                <td><strong>A10</strong></td>
                <td>SSRF</td>
                <td>Server-side request forgery</td>
                <td>Partial</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ModSecurity -->
      <section>
        <h2 id="modsecurity">ModSecurity</h2>
        <p>
          ModSecurity is the most widely deployed open-source WAF, available as a module 
          for Apache, Nginx, and IIS. Combined with OWASP Core Rule Set (CRS), it provides 
          comprehensive protection.
        </p>

        <h3>Installation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Bash</span>
            <span class="code-filename">ModSecurity Installation</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# MODSECURITY INSTALLATION
# =============================================================================

# Ubuntu/Debian - Apache
sudo apt update
sudo apt install libapache2-mod-security2
sudo a2enmod security2

# Ubuntu/Debian - Nginx (ModSecurity v3)
sudo apt install libmodsecurity3 libmodsecurity-dev
# Compile nginx with ModSecurity connector (or use pre-built)

# CentOS/RHEL - Apache
sudo yum install mod_security mod_security_crs

# Enable ModSecurity
sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
sudo sed -i 's/SecRuleEngine DetectionOnly/SecRuleEngine On/' /etc/modsecurity/modsecurity.conf

# =============================================================================
# OWASP CORE RULE SET (CRS) INSTALLATION
# =============================================================================

# Download CRS
cd /etc/modsecurity
sudo git clone https://github.com/coreruleset/coreruleset.git
cd coreruleset
sudo cp crs-setup.conf.example crs-setup.conf

# Configure Apache to load CRS
# /etc/apache2/mods-enabled/security2.conf
IncludeOptional /etc/modsecurity/*.conf
IncludeOptional /etc/modsecurity/coreruleset/crs-setup.conf
IncludeOptional /etc/modsecurity/coreruleset/rules/*.conf

# Restart Apache
sudo systemctl restart apache2</code></pre>
        </div>

        <h3>ModSecurity Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Config</span>
            <span class="code-filename">/etc/modsecurity/modsecurity.conf</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# MODSECURITY MAIN CONFIGURATION
# =============================================================================

# Enable ModSecurity
SecRuleEngine On

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temporary files
SecTmpDir /tmp/
SecDataDir /tmp/

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# Debug logging (disable in production)
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Rule engine
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine On

# =============================================================================
# CUSTOM RULES
# =============================================================================

# Block requests with no User-Agent
SecRule REQUEST_HEADERS:User-Agent "^$" \
    "id:10001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Empty User-Agent header'"

# Block SQL injection patterns
SecRule ARGS "@rx (?i)(\b(select|insert|update|delete|drop|union|exec|execute)\b)" \
    "id:10002,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Possible SQL Injection',\
    tag:'attack-sqli'"

# Block XSS patterns
SecRule ARGS "@rx (?i)(<script|javascript:|on\w+\s*=)" \
    "id:10003,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Possible XSS Attack',\
    tag:'attack-xss'"

# Rate limiting (requires mod_ratelimit or custom logic)
SecRule IP:REQUEST_COUNTER "@gt 100" \
    "id:10004,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate limit exceeded',\
    setvar:ip.request_counter=+1,\
    expirevar:ip.request_counter=60"

# Block path traversal
SecRule REQUEST_URI "@rx \.\./" \
    "id:10005,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path Traversal Attempt'"

# =============================================================================
# WHITELIST RULES (Before CRS)
# =============================================================================

# Whitelist specific IP
SecRule REMOTE_ADDR "@ipMatch 192.168.1.100" \
    "id:10100,\
    phase:1,\
    allow,\
    nolog,\
    ctl:ruleEngine=Off"

# Whitelist specific URL
SecRule REQUEST_URI "@beginsWith /api/webhook" \
    "id:10101,\
    phase:1,\
    allow,\
    nolog,\
    ctl:ruleRemoveById=942100-942999"</code></pre>
        </div>

        <h3>OWASP CRS Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Config</span>
            <span class="code-filename">crs-setup.conf</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# OWASP CRS SETUP CONFIGURATION
# =============================================================================

# Paranoia Level (1-4)
# 1 = Low false positives, basic protection
# 2 = Moderate (recommended for most sites)
# 3 = High security, more false positives
# 4 = Maximum security, many false positives
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=2"

# Anomaly scoring thresholds
# Requests exceeding these scores are blocked
SecAction \
    "id:900110,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# Allowed HTTP methods
SecAction \
    "id:900200,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# Allowed content types
SecAction \
    "id:900220,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |text/xml| |application/xml| |application/json|'"

# Block on anomaly score
SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_threshold}" \
    "id:949110,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Inbound Anomaly Score Exceeded (Total Score: %{TX.ANOMALY_SCORE})'"</code></pre>
        </div>
      </section>

      <!-- AWS WAF -->
      <section>
        <h2 id="aws-waf">AWS WAF</h2>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">AWS WAF Configuration</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# AWS WAF V2 CONFIGURATION
# =============================================================================

# Web ACL
resource "aws_wafv2_web_acl" "main" {
  name        = "production-waf"
  description = "Production WAF rules"
  scope       = "REGIONAL"  # Use "CLOUDFRONT" for CloudFront

  default_action {
    allow {}
  }

  # AWS Managed Rules - Common Rule Set
  rule {
    name     = "AWSManagedRulesCommonRuleSet"
    priority = 1

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesCommonRuleSet"
        vendor_name = "AWS"

        # Exclude specific rules if causing false positives
        rule_action_override {
          action_to_use {
            count {}
          }
          name = "SizeRestrictions_BODY"
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesCommonRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # AWS Managed Rules - SQL Injection
  rule {
    name     = "AWSManagedRulesSQLiRuleSet"
    priority = 2

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesSQLiRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesSQLiRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # AWS Managed Rules - Known Bad Inputs
  rule {
    name     = "AWSManagedRulesKnownBadInputsRuleSet"
    priority = 3

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesKnownBadInputsRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesKnownBadInputsRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # Rate Limiting Rule
  rule {
    name     = "RateLimitRule"
    priority = 4

    action {
      block {}
    }

    statement {
      rate_based_statement {
        limit              = 2000
        aggregate_key_type = "IP"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "RateLimitRule"
      sampled_requests_enabled   = true
    }
  }

  # Geo Blocking Rule
  rule {
    name     = "GeoBlockRule"
    priority = 5

    action {
      block {}
    }

    statement {
      geo_match_statement {
        country_codes = ["RU", "CN", "KP", "IR"]
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "GeoBlockRule"
      sampled_requests_enabled   = true
    }
  }

  # Custom SQL Injection Rule
  rule {
    name     = "CustomSQLiRule"
    priority = 6

    action {
      block {}
    }

    statement {
      or_statement {
        statement {
          sqli_match_statement {
            field_to_match {
              query_string {}
            }
            text_transformation {
              priority = 1
              type     = "URL_DECODE"
            }
            text_transformation {
              priority = 2
              type     = "HTML_ENTITY_DECODE"
            }
          }
        }
        statement {
          sqli_match_statement {
            field_to_match {
              body {
                oversize_handling = "CONTINUE"
              }
            }
            text_transformation {
              priority = 1
              type     = "URL_DECODE"
            }
          }
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "CustomSQLiRule"
      sampled_requests_enabled   = true
    }
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "production-waf"
    sampled_requests_enabled   = true
  }

  tags = {
    Environment = "production"
  }
}

# Associate with ALB
resource "aws_wafv2_web_acl_association" "main" {
  resource_arn = aws_lb.main.arn
  web_acl_arn  = aws_wafv2_web_acl.main.arn
}

# WAF Logging
resource "aws_wafv2_web_acl_logging_configuration" "main" {
  log_destination_configs = [aws_cloudwatch_log_group.waf.arn]
  resource_arn            = aws_wafv2_web_acl.main.arn

  logging_filter {
    default_behavior = "DROP"

    filter {
      behavior = "KEEP"
      condition {
        action_condition {
          action = "BLOCK"
        }
      }
      requirement = "MEETS_ANY"
    }
  }
}</code></pre>
        </div>
      </section>

      <!-- Azure WAF -->
      <section>
        <h2 id="azure-waf">Azure WAF</h2>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">Azure WAF Policy</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# AZURE WAF POLICY (Application Gateway)
# =============================================================================

resource "azurerm_web_application_firewall_policy" "main" {
  name                = "production-waf-policy"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location

  # Policy Settings
  policy_settings {
    enabled                     = true
    mode                        = "Prevention"  # or "Detection"
    request_body_check          = true
    file_upload_limit_in_mb     = 100
    max_request_body_size_in_kb = 128
  }

  # OWASP Managed Rules
  managed_rules {
    managed_rule_set {
      type    = "OWASP"
      version = "3.2"

      # Override specific rules
      rule_group_override {
        rule_group_name = "REQUEST-942-APPLICATION-ATTACK-SQLI"
        rule {
          id      = "942100"
          enabled = true
          action  = "Block"
        }
      }

      rule_group_override {
        rule_group_name = "REQUEST-941-APPLICATION-ATTACK-XSS"
        rule {
          id      = "941100"
          enabled = true
          action  = "Block"
        }
      }
    }

    # Bot Protection (optional)
    managed_rule_set {
      type    = "Microsoft_BotManagerRuleSet"
      version = "1.0"
    }

    # Exclusions
    exclusion {
      match_variable          = "RequestHeaderNames"
      selector                = "x-custom-header"
      selector_match_operator = "Equals"
    }
  }

  # Custom Rules
  custom_rules {
    name      = "BlockBadUserAgents"
    priority  = 1
    rule_type = "MatchRule"
    action    = "Block"

    match_conditions {
      match_variables {
        variable_name = "RequestHeaders"
        selector      = "User-Agent"
      }
      operator           = "Contains"
      negation_condition = false
      match_values       = ["BadBot", "Scanner", "sqlmap"]
      transforms         = ["Lowercase"]
    }
  }

  custom_rules {
    name      = "RateLimitByIP"
    priority  = 2
    rule_type = "RateLimitRule"
    action    = "Block"

    match_conditions {
      match_variables {
        variable_name = "RemoteAddr"
      }
      operator           = "IPMatch"
      negation_condition = true
      match_values       = ["10.0.0.0/8", "192.168.0.0/16"]
    }

    rate_limit_duration_in_minutes = 1
    rate_limit_threshold           = 100
    group_rate_limit_by            = "ClientAddr"
  }

  custom_rules {
    name      = "GeoBlock"
    priority  = 3
    rule_type = "MatchRule"
    action    = "Block"

    match_conditions {
      match_variables {
        variable_name = "RemoteAddr"
      }
      operator           = "GeoMatch"
      negation_condition = false
      match_values       = ["RU", "CN", "KP"]
    }
  }

  tags = {
    Environment = "production"
  }
}

# Associate with Application Gateway
resource "azurerm_application_gateway" "main" {
  name                = "production-appgw"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location

  # ... other configuration ...

  # WAF Configuration
  waf_configuration {
    enabled                  = true
    firewall_mode            = "Prevention"
    rule_set_type            = "OWASP"
    rule_set_version         = "3.2"
    file_upload_limit_mb     = 100
    request_body_check       = true
    max_request_body_size_kb = 128
  }

  # Or use WAF Policy
  firewall_policy_id = azurerm_web_application_firewall_policy.main.id
}</code></pre>
        </div>
      </section>

      <!-- Cloudflare WAF -->
      <section>
        <h2 id="cloudflare">Cloudflare WAF</h2>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Terraform</span>
            <span class="code-filename">Cloudflare WAF Rules</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# CLOUDFLARE WAF CONFIGURATION
# =============================================================================

# Zone settings
resource "cloudflare_zone_settings_override" "main" {
  zone_id = var.cloudflare_zone_id

  settings {
    ssl                      = "strict"
    always_use_https         = "on"
    min_tls_version          = "1.2"
    automatic_https_rewrites = "on"
    security_level           = "medium"
    waf                      = "on"
  }
}

# Custom WAF Rule - Block SQL Injection
resource "cloudflare_ruleset" "waf_custom" {
  zone_id     = var.cloudflare_zone_id
  name        = "Custom WAF Rules"
  description = "Custom WAF rules for application protection"
  kind        = "zone"
  phase       = "http_request_firewall_custom"

  # Block SQL Injection patterns
  rules {
    action      = "block"
    expression  = "(http.request.uri.query contains \"UNION\" and http.request.uri.query contains \"SELECT\") or (http.request.body.raw contains \"UNION\" and http.request.body.raw contains \"SELECT\")"
    description = "Block SQL Injection UNION SELECT"
    enabled     = true
  }

  # Block XSS patterns
  rules {
    action      = "block"
    expression  = "http.request.uri.query contains \"<script\" or http.request.body.raw contains \"<script\""
    description = "Block XSS script tags"
    enabled     = true
  }

  # Block bad bots
  rules {
    action      = "block"
    expression  = "http.user_agent contains \"sqlmap\" or http.user_agent contains \"nikto\" or http.user_agent contains \"nmap\""
    description = "Block known attack tools"
    enabled     = true
  }

  # Rate limit login attempts
  rules {
    action      = "block"
    expression  = "http.request.uri.path eq \"/login\" and http.request.method eq \"POST\""
    description = "Rate limit login"
    enabled     = true
    ratelimit {
      characteristics     = ["ip.src"]
      period              = 60
      requests_per_period = 5
      mitigation_timeout  = 600
    }
  }

  # Geo blocking
  rules {
    action      = "block"
    expression  = "ip.geoip.country in {\"RU\" \"CN\" \"KP\" \"IR\"}"
    description = "Block high-risk countries"
    enabled     = true
  }

  # Challenge suspicious requests
  rules {
    action      = "managed_challenge"
    expression  = "cf.threat_score gt 30"
    description = "Challenge high threat score"
    enabled     = true
  }
}

# Enable Cloudflare Managed Ruleset (OWASP)
resource "cloudflare_ruleset" "managed_waf" {
  zone_id     = var.cloudflare_zone_id
  name        = "Managed WAF Rulesets"
  description = "Enable Cloudflare managed WAF rules"
  kind        = "zone"
  phase       = "http_request_firewall_managed"

  # Cloudflare OWASP Core Ruleset
  rules {
    action = "execute"
    action_parameters {
      id = "efb7b8c949ac4650a09736fc376e9aee"  # OWASP ruleset ID
      overrides {
        # Increase sensitivity
        rules {
          id              = "6179ae15870a4bb7b2d480d4843b323c"
          action          = "block"
          score_threshold = 60
        }
      }
    }
    expression  = "true"
    description = "Execute OWASP Core Ruleset"
    enabled     = true
  }

  # Cloudflare Managed Ruleset
  rules {
    action = "execute"
    action_parameters {
      id = "c2e184081120413c86c3ab7e14069605"  # Cloudflare Managed ruleset
    }
    expression  = "true"
    description = "Execute Cloudflare Managed Ruleset"
    enabled     = true
  }
}

# Page Rules for additional protection
resource "cloudflare_page_rule" "admin_protection" {
  zone_id  = var.cloudflare_zone_id
  target   = "example.com/admin/*"
  priority = 1

  actions {
    security_level = "high"
  }
}</code></pre>
        </div>
      </section>

      <!-- WAF Tuning -->
      <section>
        <h2 id="tuning">WAF Tuning & False Positives</h2>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">Config</span>
            <span class="code-filename">WAF Tuning Best Practices</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code># =============================================================================
# WAF TUNING PROCESS
# =============================================================================

# PHASE 1: DETECTION MODE
# Start with logging-only mode to understand traffic patterns
# ModSecurity:
SecRuleEngine DetectionOnly

# AWS WAF: Use Count instead of Block
# Azure WAF: Use Detection mode

# PHASE 2: ANALYZE LOGS
# Look for false positives in legitimate traffic
# Common false positive triggers:
# - File uploads with code-like content
# - Rich text editors (HTML content)
# - API endpoints receiving JSON/XML
# - Search functionality with special characters

# PHASE 3: CREATE EXCLUSIONS

# ModSecurity - Exclude specific URL from rule
SecRule REQUEST_URI "@beginsWith /api/upload" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100"

# ModSecurity - Exclude specific parameter
SecRule ARGS_NAMES "content" \
    "id:1002,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:content"

# ModSecurity - Whitelist IP
SecRule REMOTE_ADDR "@ipMatch 10.0.0.0/8" \
    "id:1003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# =============================================================================
# COMMON FALSE POSITIVE SCENARIOS
# =============================================================================

# 1. JSON APIs with special characters
# Solution: Exclude JSON content-type from XSS rules
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
    "id:1010,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100-941999"

# 2. File uploads
# Solution: Exclude upload endpoints
SecRule REQUEST_URI "@rx ^/api/v[0-9]+/upload" \
    "id:1011,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=921110-921999"

# 3. Rich text editors (HTML in POST body)
# Solution: Exclude specific parameters
SecRuleUpdateTargetById 941100 "!ARGS:html_content"
SecRuleUpdateTargetById 941110 "!ARGS:html_content"

# 4. Base64 encoded data
# Solution: May trigger SQL/XSS rules, exclude endpoints
SecRule REQUEST_URI "@beginsWith /api/data" \
    "id:1012,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100"

# =============================================================================
# MONITORING & ALERTING
# =============================================================================

# Key metrics to monitor:
# - Block rate (sudden increase = attack or false positive spike)
# - Top blocked rules (identify noisy rules)
# - Top blocked IPs (identify attackers)
# - Top blocked URLs (identify problematic endpoints)

# Alert thresholds:
# - Block rate > 1% of total requests
# - Single IP blocked > 100 times/minute
# - New rule triggering > 50 times/hour</code></pre>
        </div>
      </section>

      <section>
        <div class="section-divider"><span>Related Guides</span></div>
        <div class="card-grid">
          <a href="reverse-proxy.html" class="nav-card card">
            <h4>Reverse Proxy →</h4>
            <p>Nginx, HAProxy for WAF deployment.</p>
          </a>
          <a href="ids-ips.html" class="nav-card card">
            <h4>IDS/IPS →</h4>
            <p>Network-level intrusion detection.</p>
          </a>
          <a href="best-practices.html" class="nav-card card">
            <h4>Best Practices →</h4>
            <p>Security hardening and compliance.</p>
          </a>
        </div>
      </section>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-bottom">
      <p>Network Security & Infrastructure Guide</p>
    </div>
  </footer>

  <script src="main.js"></script>
</body>
</html>
